#!/usr/bin/env bash
set -e

function printStatus {
    if [ $? -eq 0 ]; then
        echo -e "\nPOP POP POP POP POP POP POP"
    else
        echo -e "\nMAN DOWN"
    fi
}

trap printStatus EXIT

. $(dirname $0)/goenv
ROOT_DIR=$(cd $(dirname $(dirname $0)) && pwd)
GATS_GOPATH=$ROOT_DIR/tmp/gats_gopath
mkdir -p $GATS_GOPATH/src/github.com/pivotal-cf-experimental
ln -s $ROOT_DIR $GATS_GOPATH/src/github.com/pivotal-cf-experimental

go install -v github.com/onsi/ginkgo/ginkgo

rm -f bin/gcf

if [[ $1 == '-s' ]]
then
  echo "Using $(which cf) as cf"
  ln -s $(which cf) bin/cf
else
  curl -L https://s3.amazonaws.com/go-cli/builds/cf-linux-amd64 > bin/cf
  chmod +x bin/cf
fi

export local_bin=$(cd $(dirname $0) && pwd)
PATH=$PATH:$local_bin GOPATH=$(godep path):$GATS_GOPATH:$GOPATH ginkgo -r -slowSpecThreshold=120 ./gats
rm -rf $GATS_GOPATH
