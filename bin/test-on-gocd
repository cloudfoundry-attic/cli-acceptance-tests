#!/usr/bin/env bash
set -e

function printStatus {
    if [ $? -eq 0 ]; then
        echo -e "\nPOP POP POP POP POP POP POP"
    else
        echo -e "\nMAN DOWN"
    fi
}

trap printStatus EXIT

. $(dirname $0)/goenv
ROOT_DIR=$(cd $(dirname $(dirname $0)) && pwd)
CLI_ACCEPTANCE_GOPATH=$ROOT_DIR/tmp/gats_gopath
mkdir -p $CLI_ACCEPTANCE_GOPATH/src/github.com/cloudfoundry
ln -s $ROOT_DIR $CLI_ACCEPTANCE_GOPATH/src/github.com/cloudfoundry/GATS

go install -v github.com/onsi/ginkgo/ginkgo
go get -u github.com/tools/godep

rm -f bin/cf

if [[ $1 == '-s' ]]
then
  echo "Using $(which cf) as cf"
  ln -s $(which cf) bin/cf
else
  mv cf-linux-amd64 bin/cf
  chmod u+x bin/cf
fi

export local_bin=$(cd $(dirname $0) && pwd)
export PATH=$local_bin:$PATH

echo `ls -l $CLI_ACCEPTANCE_GOPATH/src/github.com/cloudfoundry/GATS/bin`
echo $local_bin
echo `ls -l $local_bin`

echo $PATH
echo `which cf`
echo `which godep`

GOPATH=$ROOT_DIR/Godeps/_workspace:$CLI_ACCEPTANCE_GOPATH:$GOPATH ginkgo -r -slowSpecThreshold=120 ./gats
rm -rf $CLI_ACCEPTANCE_GOPATH
